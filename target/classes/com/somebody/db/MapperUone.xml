<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace = "com.somebody.db.MapperUone">
    
   <select id = "meDtInfo" resultType = "beans.Members" parameterType = "beans.Members">
      SELECT  DISTINCT ME.MENAME AS meName,
        (SELECT NVL(TRUNC(MONTHS_BETWEEN(SYSDATE, TO_DATE(SUBSTR(TO_CHAR(MEBIRTH,'YYYY'),1,4),'YYYY'))/12), 0)+1 FROM KMASTERS.ME WHERE MECODE = #{meCode}) AS meBirth,
        ME.MEEMAIL AS meEmail,
        ME.MENUMBER AS meNumber,
        (SELECT CA.CANAME FROM KMASTERS.CA WHERE CA.CACODE = ME.MEGENDER)AS meGender,
        (SELECT SUM(PATOTAL) FROM KMASTERS.PA WHERE PAMECODE=#{meCode} AND PALPCTCODE =#{ctCode} ) AS paTotal,
        (SELECT SUBSTR(TO_CHAR(MAX(PADATE),'YYYYMMDD'),1,8) FROM KMASTERS.PA WHERE PAMECODE = #{meCode}) AS paDate,
        (SELECT DISTINCT SF.SFNAME FROM KMASTERS.SF WHERE LS.LSCACODE = 'L1' AND PA.PAMECODE = #{meCode} AND SF.SFCTCODE =#{ctCode} 
        AND SF.SFCODE = (SELECT DISTINCT RELSSFCODE AS sfCode
            FROM KMASTERS.SF
            WHERE RE.RELSCTCODE = #{ctCode} AND LS.LSSFCODE = RE.RELSSFCODE AND RE.REMECODE =#{meCode} )) AS sfName,
        (SELECT EQ.EQNAME FROM KMASTERS.EQ WHERE EQ.EQCODE = (SELECT LG.LGEQCODE FROM KMASTERS.LG WHERE LG.LGMECODE = ME.MECODE)) AS locker,
        
        (SELECT REGEXP_REPLACE(LISTAGG(CAST(CA.CANAME AS VARCHAR(50)),',') WITHIN GROUP (ORDER BY CA.CANAME),'([^,]+)(,\1)+', '\1') AS lsName
        FROM KMASTERS.CA INNER JOIN KMASTERS.PA ON CA.CACODE =PA.PALPCACODE WHERE PA.PAMECODE=#{meCode} AND PALPCTCODE = #{ctCode})  AS lsName,
        ME.MEPASSWORD AS mePw

      FROM KMASTERS.ME INNER JOIN KMASTERS.PA ON ME.MECODE = PA.PAMECODE
           INNER JOIN KMASTERS.CA ON PA.PALPCACODE = CA.CACODE
             INNER JOIN KMASTERS.SF ON PA.PALPCTCODE = SF.SFCTCODE
             INNER JOIN KMASTERS.LG ON ME.MECODE = LG.LGMECODE
             INNER JOIN KMASTERS.EQ ON LG.LGEQCODE = EQ.EQCODE
             INNER JOIN KMASTERS.LS ON EQ.EQCTCODE = LS.LSSFCTCODE 
             INNER JOIN KMASTERS.MG ON MG.MGCTCODE = PA.PALPCTCODE
             INNER JOIN KMASTERS.RE ON ME.MECODE = RE.REMECODE
         WHERE ME.MECODE = #{meCode} AND LS.LSSFCODE = RE.RELSSFCODE
   </select>
      
     <select id = "meInbodyMg" resultType = "beans.Inbodys" parameterType = "beans.Inbodys">
   SELECT DISTINCT SUBSTR(IDIBCODE,1,5) AS meCode,
      IDCOUNT AS idCount,
        DAUNIT AS daUnit,
        DANAME AS daName,
        SUBSTR(IDIBCODE,6,14) AS ibDate,
         (SELECT REGEXP_REPLACE(LISTAGG(CAST(EX.EXUNIT AS VARCHAR(50)),',') WITHIN GROUP (ORDER BY EX.EXUNIT),'([^,]+)(,\1)+', '\1' ) FROM KMASTERS.EX WHERE EXCODE = TAEXCODE) AS exUnit,
        (SELECT REGEXP_REPLACE (LISTAGG(CAST(TA.TAMOTION AS VARCHAR(50)),',') WITHIN GROUP (ORDER BY TA.TAMOTION),'([^,]+)(,\1)+', '\1' ) FROM KMASTERS.TA WHERE SUBSTR(TAIDIBCODE,6,14) =(SELECT SUBSTR(MAX(TAIDIBCODE),6,14) FROM KMASTERS.TA WHERE SUBSTR(TAIDIBCODE,1,5)=#{meCode}) AND SUBSTR(TAIDIBCODE,1,5)=#{meCode}) AS taMotion,
        
        (SELECT REGEXP_REPLACE(LISTAGG(CAST(EX.EXNAME AS VARCHAR(50)),',') WITHIN GROUP (ORDER BY EX.EXNAME),'([^,]+)(,\1)+', '\1' )
        FROM KMASTERS.EX INNER JOIN KMASTERS.TA ON EX.EXCODE = TA.TAEXCODE
        WHERE SUBSTR(TAIDIBCODE,6,14) =(SELECT SUBSTR(MAX(TAIDIBCODE),6,14) FROM KMASTERS.TA WHERE SUBSTR(TAIDIBCODE,1,5)=#{meCode}) AND SUBSTR(TAIDIBCODE,1,5)=#{meCode}
        ) AS exName,
        (SELECT STNAME FROM KMASTERS.ST WHERE STCODE = (SELECT PESTCODE FROM KMASTERS.PE WHERE SUBSTR(PETAIDIBCODE,1,5)= #{meCode} AND SUBSTR(PETAIDIBCODE,6,8)=#{ibDate1}))  AS stCode
        
    
    
   FROM KMASTERS.ID INNER JOIN KMASTERS.DA ON ID.IDDACODE = DA.DACODE
                    INNER JOIN KMASTERS.TA ON  ID.IDIBCODE = TA.TAIDIBCODE
                    INNER JOIN KMASTERS.EX ON TA.TAEXCODE = EX.EXCODE
                    INNER JOIN KMASTERS.PE ON EX.EXCODE = PE.PETAEXCODE and pe.petaidibcode = id.idibcode
                    INNER JOIN KMASTERS.ST ON PE.PESTCODE = ST.STCODE
   WHERE SUBSTR(IDIBCODE,6,8) = #{ibDate1} AND SUBSTR(IDIBCODE,1,5) = #{meCode} ORDER BY DANAME ASC
   </select>
   
   <update id="delMe" parameterType ="beans.Members">
      UPDATE KMASTERS.ME SET MEBIRTH = (SELECT SYSDATE FROM DUAL) , MEEMAIL = 'DELETE',MENAME ='DELETE',MENUMBER='DELETE',MEPASSWORD='DELETE' WHERE MECODE =#{meCode}
   </update>
   
   <update id="modMeMg"  parameterType = "beans.Members">
      UPDATE KMASTERS.ME SET MEBIRTH = #{meBirth} , MENAME = #{meName} , MENUMBER = #{meNumber} WHERE MECODE = #{meCode}
   </update>

  <update id="insTaState" parameterType = "beans.Inbodys">
      UPDATE KMASTERS.PE SET PE.PESTCODE = '${peStcode}' WHERE SUBSTR(PE.PETAIDIBCODE,6,14)= ${ibDate}
   </update>
   
   <select id="findDay" parameterType = "beans.Inbodys" resultType = "beans.Inbodys">
   SELECT DISTINCT SUBSTR(PETAIDIBCODE,6,8) AS findDay ,SUBSTR(PETAIDIBCODE,1,5) AS meCode FROM KMASTERS.PE WHERE SUBSTR(PETAIDIBCODE,1,5)= #{meCode} ORDER BY SUBSTR(PETAIDIBCODE,6,8) DESC
   </select>
   
   <select id="maxDay" parameterType = "beans.Inbodys" resultType = "beans.Inbodys">
   SELECT DISTINCT IDCOUNT AS idCount,
        DAUNIT AS daUnit,
        DANAME AS daName,
        SUBSTR(IDIBCODE,6,14) AS ibDate,
         (SELECT REGEXP_REPLACE(LISTAGG(CAST(EX.EXUNIT AS VARCHAR(50)),',') WITHIN GROUP (ORDER BY EX.EXUNIT),'([^,]+)(,\1)+', '\1' ) FROM KMASTERS.EX WHERE EXCODE = TAEXCODE) AS exUnit,
        (SELECT REGEXP_REPLACE (LISTAGG(CAST(TA.TAMOTION AS VARCHAR(50)),',') WITHIN GROUP (ORDER BY TA.TAMOTION),'([^,]+)(,\1)+', '\1' ) FROM KMASTERS.TA WHERE SUBSTR(TAIDIBCODE,6,14) =(SELECT SUBSTR(MAX(TAIDIBCODE),6,14) FROM KMASTERS.TA WHERE SUBSTR(TAIDIBCODE,1,5)=#{meCode}) AND SUBSTR(TAIDIBCODE,1,5)=#{meCode}) AS taMotion,
        
        (SELECT REGEXP_REPLACE(LISTAGG(CAST(EX.EXNAME AS VARCHAR(50)),',') WITHIN GROUP (ORDER BY EX.EXNAME),'([^,]+)(,\1)+', '\1' )
        FROM KMASTERS.EX INNER JOIN KMASTERS.TA ON EX.EXCODE = TA.TAEXCODE
        WHERE SUBSTR(TAIDIBCODE,6,14) =(SELECT SUBSTR(MAX(TAIDIBCODE),6,14) FROM KMASTERS.TA WHERE SUBSTR(TAIDIBCODE,1,5)=#{meCode}) AND SUBSTR(TAIDIBCODE,1,5)=#{meCode}
        ) AS exName,
        (SELECT STNAME FROM KMASTERS.ST WHERE STCODE = (SELECT PESTCODE FROM KMASTERS.PE WHERE SUBSTR(PETAIDIBCODE,1,5)= #{meCode} AND SUBSTR(PETAIDIBCODE,6,8)=(SELECT SUBSTR(MAX(TAIDIBCODE),6,8) FROM KMASTERS.TA WHERE SUBSTR(TAIDIBCODE,1,5) = #{meCode})))  AS stCode
    
   FROM KMASTERS.ID INNER JOIN KMASTERS.DA ON ID.IDDACODE = DA.DACODE
                    INNER JOIN KMASTERS.TA ON  ID.IDIBCODE = TA.TAIDIBCODE
                    INNER JOIN KMASTERS.EX ON TA.TAEXCODE = EX.EXCODE
                    INNER JOIN KMASTERS.PE ON EX.EXCODE = PE.PETAEXCODE 
                    INNER JOIN KMASTERS.ST ON PE.PESTCODE = ST.STCODE
   WHERE SUBSTR(IDIBCODE,6,14) = (SELECT SUBSTR(MAX(TAIDIBCODE),6,14) FROM KMASTERS.TA WHERE SUBSTR(TAIDIBCODE,1,5) = #{meCode}) AND SUBSTR(IDIBCODE,1,5) = #{meCode} ORDER BY DANAME ASC
   </select>
   <select id="inbodyChart" parameterType = "beans.Inbodys" resultType = "beans.Inbodys">
   SELECT DISTINCT DANAME AS daName,
    IDCOUNT AS idCount,
    SUBSTR(IDIBCODE,6,8) AS ibDate
    FROM KMASTERS.DA INNER JOIN KMASTERS.ID ON DA.DACODE = ID.IDDACODE
    WHERE SUBSTR(IDIBCODE,1,5) = #{meCode} AND SUBSTR(IDIBCODE,6,8) IN   (SELECT SUBSTR(IDIBCODE,6,8) FROM (SELECT DISTINCT IDIBCODE FROM KMASTERS.ID ORDER BY SUBSTR(IDIBCODE,6,8) DESC) WHERE ROWNUM <![CDATA[<]]>=3 AND SUBSTR(IDIBCODE,1,5)=#{meCode})
    and (DACODE = 10001 or DACODE = 10002 or DACODE = 10003)
    ORDER BY SUBSTR(IDIBCODE,6,8) DESC
   </select>
	
</mapper>